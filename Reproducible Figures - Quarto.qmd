---
title: "Reproducible Figures - Assessed"
format: html
fig-width: 10
fig-height: 9
editor: visual
bibliography: references.bib
---

## ![Adelie Penguin Walking](images/Adelie%20Penguin%20Image.jpeg)

### **QUESTION 01: Data Visualisation for Science Communication**

Initially, I will be using the Palmer Penguin dataset to build a misleading graph. This firstly requires appropriate loading and cleaning of the data. My code is as follows:

```{r}
#| echo: true
#| warning: false
#| message: false
#| label: loadingdata
renv::restore() #stores appropriate versions of libraries downloading 

### download necessary libraries 
library(boot)
library(dplyr)
library(here)
library(hrbrthemes)
library(ggplot2)
library(gridExtra)
library(janitor)
library(palmerpenguins)
library(ragg)
library(svglite)
library(tidyr)
library(tidyverse)
library(viridis)
library(yaml)

#turning the palmer penguins raw data into a csv file: 
write_csv(penguins_raw, here("data", "penguins_raw.csv")) 

#reading in the csv file: 
penguins_raw <- read.csv(here("data", "penguins_raw.csv"))

#creating a piped function to clean the penguin data:

cleaning_penguins <- function(penguins_raw){
  penguins_raw %>%
    clean_names() %>%
    remove_empty(c("rows", "cols")) %>%
    select(-starts_with("delta")) %>%
    select(-"comments")
}

penguins_clean <- cleaning_penguins(penguins_raw) #assign the cleaned data 

#writing a csv with the new, cleaned data:
write.csv(penguins_clean, here("data", "penguins_clean.csv")) 
```

My misleading graph is the following:

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: misleadinggraph
#| fig-cap: Misleading Graph

#creating a misleading graph using the ggplot function 

ggplot(penguins_clean, aes(x = culmen_length_mm, y = body_mass_g)) + #assigning data and axes
  geom_point(aes(color = island), alpha = 0.5) + #scatter graph format, assigning islands 
  geom_jitter(aes(color = island), width = 20, height = 20) + #increasing jitter on islands
  geom_smooth(method = "lm", color = "yellow", se = TRUE) + #creating a linear regression with standard error 
  scale_x_reverse() + #reversing the x-axis
  labs(title = "Does Culmen Length Affect Body Mass in Different Penguin Species?", #graph title
       x = "Length", #x labels 
       y = "Mass") + #y labels 
  theme_minimal() #assigning a theme 
```

In order to make a plot which is correct, but badly communicates the underlying data, I made a series of design choices in the generation process to mislead the reader. I chose to visualise the relationship between culmen length (measured in mm), and body mass (measured in grams). However, the axes titles I used were highly generalised to "Length" and "Mass", without their units, in order to minimise the possibility of appropriate interpretation. I chose to build a scatter plot - which are generally used to represent a relationship between two continuous variables. However, I gave the title "Does Culmen Length Affect Body Mass in Different Penguin Species"; intimating a causal study, when in fact the visualisation produced is purely correlational. Moreover, I chose to subset the data with regards to Island, as different species of penguin are found on different islands. Specifically, Adelaides are found on all islands, Gentoos only on Biscoe and Chinstraps only on Dream. As such, information about species cannot be divined from visualisations of islands, as is implied by the title. Islands were colour-coded using a very colour-blind unfriendly palette, including simultaneous use of reds and greens. I added a regression line to the plot, with standard errors that are not explained, and therefore very difficult to interpret. With regards to the axes, I reversed Length on the x-axis, in order to mislead a reader on initial assessment into perceiving the correlation as negative when it is actually positive. Finally, I also increased the "jitter" to 20. This added a significant amount of random noise to the plot. Visually spreading out the points extended them past the linear regression, making it even harder to interpret.

### **QUESTION 02: Data Pipeline**

#### Introduction

The Palmer Penguins dataset records observations of foraging Adélie (*Pygoscelis adeliae*), Chinstrap (*Pygoscelis antarcticus*) and Gentoo (*Pygoscelis papua*) penguin species, near the Palmer Station, in the Palmer Archipelago, Antarctica. Recorded observations for each individual notes the specific species, as well as the specific island (of Briscoe, Dream or Torgersen) in the Anvers region; as well as the developmental stage. Each observation is given an ID. Data collected include: clutch completion (either yes or no), the date of egg laying (YYYY-MM-DD), culmen length and depth as well as flipper length (all measured in mm), body mass (measured in grams), and sex (M/F).

In my pipeline, having loaded and cleaned my data, I will pose my [questions]{.underline} and [hypotheses]{.underline}, explain the [statistical method]{.underline} I have chosen to adopt for my present analysis, explore and discuss my [results]{.underline} (using both an exploratory and a results figure, which I will save[)]{.underline}, and ultimately [conclude]{.underline} my analysis with reference to its wider relevance.

**My question:** is there a correlation between body mass and flipper length in different penguin species' (here: Adélie, Chinstrap and Gentoo)?

Correlations between morphological traits (such as body mass and flipper length) are sometimes controlled by morphometric scaling [@shingleton2010]. Morphometrically-scaled correlations are underpinned by the study of allometry: differences in the morphological growth [@nijhout2012]. Allometry is a topic of current interest fundamentally, but also partly because morphological structure and function can exert a profound effect on an organism's ecology.

I find penguin allometry a specifically interesting case study to run, because of the proposed effect of penguin morphology on ecology, arising from morphometric scaling. For example, we already know that Gentoo penguins with a larger body mass and flipper length can dive deeper to forage, due to their muscle mass [@mccomb-turbitt2023]. In order to explore whether this ecological phenomenon might be underpinned by morphometric scaling, investigating a potential correlation is an interesting place to start.

#### Hypothesis

**My Null Hypothesis (H~0~):** there is no correlation between body mass and flipper length in any of the investigated penguin species'.

**My Alternate Hypothesis (H~A~):** there is a correlation between body mass and flipper length in one (or more) of the investigated penguin species'.

To contextualise these hypotheses, under H~0~ (no correlation between body mass and flipper length) there would be no morphometric scaling between these morphological traits. However, under H~A~, there would be morphometric scaling - thus revealing an interesting allometric facet of penguin development, with potential implications for their ecology.

#### Stats Method

In order to test my H~0~, I conduct a Pearson's correlation coefficient analysis on two numerical variables included within the Palmer Penguins dataset - body mass (measured in grams), and flipper length (measured in mm).

Pearson's correlation coefficient is a parametric measure of the linear relationship between two numeric variables, which can range from -1 (a perfect negative correlation), to +1 (a perfect positive correlation). It is useful as an introductory point for testing Hypotheses such as mine, because it is a relatively simple statistical measure, that is commonly employed and therefore well-understood[@hashash2022] .

Pearson's correlation coefficient has precedent for use in investigating potential morphometric scaling. For example, it has previously been used in studying correlations between human brain segregation and integration units [@li2024].

The equation for Pearson's correlation coefficient is given as:

$$r = \Sigma(x_i-\bar x)(y_i-\bar y)/ \sqrt\Sigma(x_i-\bar x)(y_i-\bar y)$$\$\$\$\$

To compare correlations between each species, I bootstrapped the correlation coefficient estimates, in order to maximise statistical accuracy [@efron1993]. In order to make this bootstrapping reproducible, I have set a seed in my code.

Pearson's correlation coefficient assumes that data are distributed normally [@hashash2022a]. I have tested this in the [Supplementary Materials]{.underline} section.

#### Results

To gain an initial appreciation of the data, but not yet to run any statistical tests, I first created an exploratory figure. Exploratory figures are important to gain an appreciation for your data, without yet subjecting it to any rigorous testing [@wickham2023].

Here, I generated a density figure to show the distribution of the raw data for my two variables of interest: body mass (g), and flipper length (mm).

```{r}
#| echo: true
#| message: false
#| warning: false
#| label: exploratoryfigure
#| fig-cap: Fig 1, exploratory figure

##Firstly, I create a density plot of body masses by species 

body_mass_density <- ggplot(data=penguins_clean, aes(x=body_mass_g, group=species, fill=species)) + #assigning a ggplot to penguins data with my variable of interest: body mass on x axes; subset by species 
  geom_density(adjust=1, alpha = 0.75) + #density plot, smoothed to 1.0 for readability, and made slightly more transparent (0.75) for aesthetics 
  scale_fill_viridis(discrete = TRUE, alpha = 0.75) + #colour-friendly palette fills plots,    made slightly transparent for aesthetics  
  scale_color_viridis(discrete = TRUE, alpha = 0.75) + #colour-friendly palette around outside, too 
  labs(title = "Fig 1a | Density of Body Masses by Species", #graph title with figure reference
       x = "Body Mass (g)", #x-axis title with units 
       y = "Density") + #y-axis title (does not require units)
  theme_ipsum() + #chosen for publication-quality figures 
  theme(
    legend.position="right", #moving the legend to the right, for readability 
    plot.title = element_text(hjust = 0.5, vjust = 0, size =15, face = "bold", family = "Times New Roman"), ### adjusting axes titles, text and legends for aesthetic spacing (central location), larger font size and emboldened for readability, publication-quality font chosen
    axis.title.x = element_text(hjust = 0.5, size = 12, family = "Times New Roman"),
    axis.title.y = element_text(hjust = 0.5, size = 12, family = "Times New Roman"),
    axis.text.x = element_text(size = 9, family = "Times New Roman"),
    axis.text.y = element_text(size = 9, family = "Times New Roman"),
    legend.key.size = unit(1.1, "cm"),
    legend.title = element_text(size = 11.5, family = "Times New Roman"),
    legend.text = element_text(size = 8, family = "Times New Roman"))

## Next, I create the same plot, but for flipper length. 

flipper_length_density <- ggplot(data=penguins_clean, aes(x=flipper_length_mm, group=species, fill=species)) +
  geom_density(adjust=1, alpha = 0.75) +
  scale_fill_viridis(discrete = TRUE, alpha = 0.75) +
  scale_color_viridis(discrete = TRUE, alpha = 0.75) +
  labs(title = "Fig 1b | Density of Flipper Lengths by Species", 
       x = "Flipper Length (mm)", 
       y = "Density") +
  theme_ipsum() +
  theme(
    legend.position="right",
    plot.title = element_text(hjust = 0.5, vjust = 0, size =15, face = "bold", family = "Times New Roman"),
    axis.title.x = element_text(hjust = 0.5, size = 12, family = "Times New Roman"),
    axis.title.y = element_text(hjust = 0.5, size = 12, family = "Times New Roman"),
    axis.text.x = element_text(size = 9, family = "Times New Roman"),
    axis.text.y = element_text(size = 9, family = "Times New Roman"),
    legend.key.size = unit(1.1, "cm"),
    legend.title = element_text(size = 11.5, family = "Times New Roman"),
    legend.text = element_text(size = 8, family = "Times New Roman"))

## Now, I print them both as a mutli-panel figure

grid.arrange(body_mass_density, flipper_length_density, nrow = 2)
```

Density plots are useful because of their estimate of the probability density function. This produces a smooth curve, from which it is easy to perceive data distribution.

Fig 1a shows body mass (g) on the x-axis, and density (the smoothed distribution of the continuous data) on the y-axis. Here, we can perceive overlapping densities of body masses between the 3 species, illustrating that the penguins exhibit similar overall body masses. However, a rough hierarchy emerges with regards to increasing body mass: Gentoo (yellow) \> Chinstrap (teal) \> Adélie (purple).

Fig 1b recapitulates a similar pattern. Here, we have flipper length (mm) on the x-axis, and density on the y-axis. Despite density overlap, an approximate hierarchy of increasing flipper length of Gentoo \> Chinstrap \> Adélie also emerges.

Hence, according to our exploratory Figure, all 3 species of penguin are morphologically similar with regard to their body mass and flipper length. However, a slight hierarchical patterns emerges.

For reproducibility, it is important that the figures as I have generated them under this current investigation are saved and kept, for maximum transparency [@schwab2022]. They can be found in the "figures" folder of my Reproducible Figures Project. I give the code for my figure-saving function, which itself is also saved in the "functions" folder of my Reproducible Figures Project, below.

```{r}
#| echo: true
#| message: false
#| warning: false
#| label: saving exploratory figure

## In order to save this figure, I create another function: 

save_figure_png <- function(plot_object,
                        filename, size, res, scaling) {
  agg_png(filename, 
          width = size, 
          height = size, 
          units = "cm", 
          res = res, 
          scaling = scaling
          )
  print(plot_object)
  dev.off()
}

## Then call this function with regard to the exploratory figure:

save_figure_png(body_mass_density,
                here("figures", "Figure1_body_mass_density_plot.png"), 
                size = 50, res = 500, scaling = 2)
save_figure_png(flipper_length_density,
                here("figures", "Figure1_flipper_length_density_plot.png"), 
                size = 50, res = 500, scaling = 2)
```

Having gained a species-specific appreciation for the body mass and flipper length data, we can now ask the question:

*Are the morphological traits of body mass and flipper length characteristics correlated?*

To test this, I conduct a Pearson's correlation coefficient analysis.

```{r}
#| echo: true
#| warning: false
#| message: false
#| label: correlation test 
#| fig-cap: Correlation Test

## Firstly, I extract the correlation coefficient and associated p-values from the cleaned penguin data, subset by species

correlation_data <- penguins_clean %>%
  group_by(species) %>%
  summarize(
    correlation_coefficient = cor(body_mass_g, flipper_length_mm, use = "complete.obs"), #removed any rows with NA, which would prevent a correlation calculation
    p_value = cor.test(body_mass_g, flipper_length_mm)$p.value) %>%
   as.data.frame() #organise as a table

## Then, I use the knitr package to create a more readable table. This requires 25 digits to display a comparative p-value for Gentoo; it being so small. I add a title, for further readability. 

knitr::kable(correlation_data, format = "markdown", digits = 25, caption = "Species correlation coefficients and associated p-values")

```

Here, our table output shows a positive correlation coefficient for each of the 3 species, between body mass and flipper length. Moreover, each of these positive correlations is highly significant under the Pearson's correlation coefficient analysis. This is shown by each of their associated p values being \<0.05, the conventionally utilised alpha significance level [@schwab2022].

Correlations are more easily appreciated under visualisation. To facilitate this therefore, I built a scatter plot results figure, displaying the correlation between body mass (g) and flipper length (mm), for each species.

```{r}
#| echo: true
#| warning: false
#| message: false
#| label: results figure
#| fig-cap: Fig 2, results figure

## To create my Results Figure, I will generate a triplet scatterplot of flipper length against body mass by species, show the linear correlation with a regression line and standard error, and print the significant p-values atop this. 

results_figure <- ggplot(penguins_clean, aes(x = body_mass_g, y = flipper_length_mm, color = species, shape = species)) +
  geom_point(size = 2.5, alpha = 0.75) +
  geom_smooth(method = "lm", se = TRUE) +  # Removed the `fill` aesthetic
  scale_color_viridis_d() +
  labs(
    title = "Fig 2 | Scatter Graph of Flipper Length Against Body Mass, Colored by Species",
    x = "Body Mass (g)",
    y = "Flipper Length (mm)",
    color = "Species"
  ) +
  theme_minimal() +
  scale_x_continuous(limits = c(2500, 6500)) +
  scale_y_continuous(limits = c(160, 240)) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 18, family = "Times New Roman"),
    axis.title = element_text(face = "bold", size = 17, family = "Times New Roman"),
    axis.text = element_text(size = 12, family = "Times New Roman"),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.title = element_text(size = 15, family = "Times New Roman"),
    legend.text = element_text(size = 12, family = "Times New Roman")
  ) +
  annotate("text", x = 5500, y = 190, 
           label = paste("Adelie: p =", format(correlation_data$p_value[1], scientific = TRUE)),
           size = 4, hjust = 0, fontface = "bold", colour = "purple") +
  annotate("text", x = 5500, y = 185, 
           label = paste("Chinstrap: p =", format(correlation_data$p_value[2], scientific = TRUE)),
           size = 4, hjust = 0, fontface = "bold", colour = "blue") +
  annotate("text", x = 5500, y = 180, 
           label = paste("Gentoo: p =", format(correlation_data$p_value[3], scientific = TRUE)),
           size = 4, hjust = 0, fontface = "bold", colour = "black")


results_figure
```

Figure 2 is a scatter plot which shows body mass (g) on the x-axis, and flipper length (mm) on the y-axis. Scatter plots are useful because they can facilitate easy perception of correlations between two numerical variables.

Each of the species of penguin demonstrates a positive correlation between these two variables, which can be assessed visually, by use of the species-specific regression lines. Standard errors surround these regression lines in shaded grey, in order to visually quantify the certainty of the correlation.

Notably, a Pearson's correlation coefficient also assumes an approximately linear relationship between variables [@hashash2022b], which can also be verified using the linear regressions applied to this scatter plot. The significant p-values for each species are also annotated onto the plot, for ease of visual appreciation. The Gentoo p-value must be displayed in black as opposed to yellow, for readability.

Clearly, this results plot exemplifies the positive correlation between body mass and flipper length for all 3 of the penguin species. To link this back to my hypotheses, here we can see that H~0~ (a hypothesis of no correlation between body mass and flipper length for any of the penguins) is statistically disproven, allowing us to reject it. We have evidence that indicates morphometric scaling of body mass and flipper length in these penguin species.

Once again, it is important for maximum reproducibility that there is a saved copy of my generated Figure 2 [@schwab2022a]. I save it to the "figures" folder of my Project using the following code:

```{r}
#| echo: true
#| message: false
#| warning: false
#| label: saving results figure

## I reuse the previously made function to save the results figure: 

save_figure_png(results_figure,
                here("figures", "Figure2_scatter_plot.png"), 
                size = 30, res = 100, scaling = 1)
```

It is clear that there exist positive correlations between body mass (g) and flipper length (mm) for all 3 penguin species.

*Do these correlations significantly vary between the species?*

In order to address this question, it is best practice to bootstrap our Pearson's correlation coefficient estimates, to maximise our chances of achieving statistical accuracy [@efron1993a].

```{r}
#| echo: true
#| warning: false
#| message: false
#| label: bootstrapped correlation test 
#| fig-cap: Bootstrapped Correlation Test

## For my boostrapped correlation test, I first define a function, which is saved in the functions folder, for ease of access. 

correlation_function <- function(data, indices) {
  resampled_data <- data[indices, ]
  cor(resampled_data$body_mass_g, resampled_data$flipper_length_mm, use = "complete.obs")
} #any rows with NA are not taken into consideration, as this would prevent the calculation of a correlation 

## Next, I run the bootstrapping for each species using this function. I set a seed to ensure reproducibility. 

bootstrap_results <- penguins_clean %>%
  group_by(species) %>%
  do({
    set.seed(2963)
    res <- boot(data = ., statistic = correlation_function, R = 1000) #repeated 1000 times, according to convention from the literature (cited below)
    ci_lower <- quantile(res$t, 0.025) #calculating the lower bound of the 95% confidence interval
    ci_upper <- quantile(res$t, 0.975) #calculating the upper bound of the 95% confidence interval
    data.frame(correlation = mean(res$t), ci_lower = ci_lower, ci_upper = ci_upper)
  }) #outputting the result as a table

# Building a nicer looking table, for readibility. 4dp again chosen for scientific precision. Appropriate title given. 
knitr::kable(bootstrap_results, format = "markdown", digits = 4, caption = "Correlation Coefficients + 95% CIs for Bootstrapped Data")
```

The results of this bootstrapping of our Pearson's correlation coefficient estimates shows that all 95% confidence intervals overlap. As such, we can infer that there is no significant difference between the strength of the positive correlation between body mass (g), and flipper length (mm), between these 3 different species of penguin.

#### Discussion

Initially, I generated an exploratory figure of density plots for both body mass and flipper length, between all 3 species of penguin. It is clear that they display similar body masses and flipper lengths. However, an approximate hierarchy emerges that is recapitulated between both morphological traits, where Gentoos are the largest, Chinstraps are intermediate and Adelies are smallest. The overlapping densities would indicate that this is not significant, and as it is an exploratory figure, no formal statistical analysis was conducted.

Our Pearson's r correlation coefficient analysis outputted a highly significant correlation between body mass and flipper length for each of the 3 species, which is easily visualised using Fig 2. This allows us to reject our H~0~, and is indicative of morphometric scaling between the morphological traits of body mass and flipper length in each of the 3 species.

Finally, we tested whether there was a significant difference in any of the correlations between the 3 species. Due to overlapping 95% confidence intervals of the bootstrapped Pearson's correlation coefficients, we have no evidence to suggest this.

Taking all of this evidence together, we can infer that morphometric scaling does occur between body mass and flipper length for each of these 3 penguin species to a similar degree. As such, this does not support a proposed effect of morphometric scaling enforcing a downstream ecological effect between the species. Perhaps these ecological differences, such as the ability of Gentoo penguins to forage deeper, arise from alternative sources: such as physiological differences. Ultimately, the testing of this hypothesis would require its own data collection and analysis.

#### Conclusion

The study of allometry, and the correlations that arise due to morphometric scaling is important in biology. Understanding the "patterns of design" that constrain morphology is fundamental to developmental scientists, and the potential ecological repercussions of evolutionary changes in morphometric scaling are exciting. This present study has confirmed evidence of morphometric scaling 3 species of penguin: Gentoo, Chinstrap and Adélie; but no evidence of a change in this scaling between species that would be proposed to have an ecological effect. However, potential studies in other species, or investigating other scaled morphological traits would be able to further plumb this scientific line of inquiry. The application of universal principles of structure and function can link both development and ecological biology in an exciting way, and this is being appreciated in a recent burst of publications investigating such relationships.

#### Supplementary Material

::: callout-important
## Pearson's Correlation Coefficient requires data to be normal
:::

```{r}
#| echo: true
#| warning: false
#| message: false
#| label: normality testing 

## In order to appropriately apply a Pearson's r correlation coefficient, the data must be normal. I check this using a QQ-Plot. 

#the initial qq-plot to test the normality of the body mass data, given an appropriate title, and summarised in red by convention 

qqnorm(penguins_clean$body_mass_g, main = "QQ Plot for Body Mass (g)")
qqline(penguins_clean$body_mass_g, col = "red")

## Next, I test the normality of the flipper data, using the same format. 

qqnorm(penguins_clean$flipper_length_mm, main = "QQ Plot for Flipper Length (mm)")
qqline(penguins_clean$flipper_length_mm, col = "red")
```

### **QUESTION 03: Data Visualisation for Science Communication**

I have uploaded my RProject to GitHub: [Repository Link](https://github.com/daisyjeans/Reproducible-Figures/tree/main "Git")\
N.B. two contributors are noted for this repository: daisyjeans and daisyjeans2. Both contributors are myself.
